{% extends 'base.html' %}
{% load static humanize %}
{% block title %}{{ product.name }}{% endblock %}
{% block content %}

<main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <a href="{% url 'main:show_main' %}" class="inline-flex items-center text-sm text-gray-700 hover:text-violet-700">
    ← Back
  </a>

  <article class="mt-3 bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-soft">
    <!-- header -->
    <header class="px-5 sm:px-7 pt-5">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">{{ product.name }}</h1>
      <p class="mt-2 text-gray-700 text-sm sm:text-base">
        <b>{{ product.get_category_display }}</b>
        {% if product.is_featured %} <span class="mx-1">|</span>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-violet-100 text-violet-800 border border-violet-200">
            Featured
          </span>
        {% endif %}
        <span class="mx-1">|</span>
        <i>{{ product.created_at|date:"d M Y, H:i" }}</i>
        <span class="mx-1">|</span>
        Views: <span id="views-count">{{ product.views }}</span>
      </p>
    </header>

    <!-- image -->
    {% if product.thumbnails %}
      <div class="mt-4">
        <img src="{{ product.thumbnails }}" alt="{{ product.name }}"
             class="w-full max-h-[520px] object-cover bg-gray-100">
      </div>
    {% else %}
      <div class="mt-4 aspect-[16/9] bg-gray-100 grid place-items-center text-gray-500">
        <img src="{% static 'image/no-products.png' %}" alt="" class="w-20 opacity-70">
      </div>
    {% endif %}

    <!-- body -->
    <div class="px-5 sm:px-7 py-6">
      <p class="text-gray-700"><b>Brand:</b> {{ product.brand|default:"—" }}</p>
      <p class="text-gray-700 mt-1"><b>Price:</b> Rp{{ product.price|intcomma }}</p>
      <p class="text-gray-800 mt-4 whitespace-pre-line">{{ product.description }}</p>

      <div class="mt-6 flex items-center gap-3">
        <a href="{% url 'main:show_main' %}"
           class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Back to list</a>

        {% if user.is_authenticated and user.id == product.user_id %}
          <a href="{% url 'main:edit_product' product.id %}"
             class="px-4 py-2 rounded-lg bg-violet-600 text-white hover:bg-violet-700">Edit</a>
          <form method="POST" action="{% url 'main:delete_product' product.id %}" onsubmit="return confirm('Delete this product?');">
            {% csrf_token %}
            <button class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Delete</button>
          </form>
        {% endif %}
      </div>
    </div>
  </article>
</main>

<script>
  // Increment views and reflect it on the page
  (async () => {
    try {
      const res = await fetch("{% url 'main:api_product_detail' product.id %}?track=1", {
        headers: {"Accept":"application/json"},
        credentials: 'same-origin'
      });
      const data = await res.json().catch(() => null);
      if (data && data.ok && data.item && typeof data.item.views !== 'undefined') {
        const el = document.getElementById('views-count');
        if (el) el.textContent = data.item.views;
      }
    } catch (_) {
      // silent fail; views just won't update live
      console.warn('View tracking failed');
    }
  })();
</script>

{% endblock %}
